<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amigas de Oração - Sorteio</title>
  <style>
    :root {
      --primary: #cf7c00;
      --primary-light: #b18a0a;
      --primary-dark: #bd850e;
      --secondary: #f5f6fa;
      --text: #2d3436;
      --light: #ffffff;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: var(--secondary);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    header {
      background-color: var(--primary);
      color: var(--light);
      text-align: center;
      padding: 2rem 1rem;
      box-shadow: var(--shadow);
    }
    
    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    
    .subtitle {
      font-size: 1.2rem;
      font-weight: 300;
      margin-bottom: 1rem;
    }
    
    main {
      max-width: 800px;
      width: 90%;
      margin: 2rem auto;
      padding: 2rem;
      background-color: var(--light);
      border-radius: 10px;
      box-shadow: var(--shadow);
      flex: 1;
    }
    
    .step {
      margin-bottom: 2rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .step:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    h2 {
      color: var(--primary);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
    }
    
    .step-number {
      background-color: var(--primary);
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      margin-right: 10px;
      font-size: 0.9rem;
      font-weight: bold;
    }
    
    .file-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      border: 2px dashed #ddd;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }
    
    .file-upload:hover {
      border-color: var(--primary-light);
    }
    
    #file-input {
      display: none;
    }
    
    button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    button:hover {
      background-color: var(--primary-dark);
    }
    
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    
    button i {
      margin-right: 8px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    
    th, td {
      border: 1px solid #e0e0e0;
      padding: 10px;
      text-align: left;
    }
    
    th {
      background-color: #f5f5f5;
    }
    
    .result-container {
      margin-top: 1.5rem;
    }
    
    .whatsapp-button {
      background-color: #25D366;
      margin-top: 1rem;
    }
    
    .whatsapp-button:hover {
      background-color: #128C7E;
    }
    
    .instruction {
      font-size: 0.9rem;
      color: #666;
      margin-top: 0.5rem;
    }
    
    .hidden {
      display: none;
    }
    
    footer {
      text-align: center;
      padding: 1.5rem;
      background-color: var(--primary);
      color: var(--light);
      margin-top: auto;
    }
    
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 4px solid white;
      width: 24px;
      height: 24px;
      margin-right: 10px;
      animation: spin 1s linear infinite;
      display: none;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: white;
      border-radius: 10px;
      padding: 2rem;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .modal-title {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }
    
    .participant-card {
      padding: 1rem;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .participant-card:last-child {
      margin-bottom: 0;
    }
    
    .close-button {
      background-color: #e0e0e0;
      color: var(--text);
      border: none;
      padding: 10px 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 1rem;
    }
    
    .close-button:hover {
      background-color: #d0d0d0;
    }
    
    @media (max-width: 600px) {
      main {
        padding: 1rem;
      }
      
      h1 {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Amigas de Oração</h1>
    <p class="subtitle">Conectando corações por meio da oração</p>
  </header>
  
  <main>
    <div class="step">
      <h2><span class="step-number">1</span> Carregar Lista de Participantes</h2>
      <p>Primeiro, carregue uma planilha Excel (.xlsx) ou CSV com as colunas "Nome" e "WhatsApp".</p>
      
      <div class="file-upload" id="drop-area">
        <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        <p>Arraste o arquivo aqui ou <strong>clique para selecionar</strong></p>
        <input type="file" id="file-input" accept=".xlsx,.csv">
      </div>
      
      <div id="preview" class="hidden">
        <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">Participantes:</h3>
        <table id="participants-table">
          <thead>
            <tr>
              <th>Nome</th>
              <th>WhatsApp</th>
            </tr>
          </thead>
          <tbody id="participants-tbody"></tbody>
        </table>
      </div>
    </div>
    
    <div class="step">
      <h2><span class="step-number">2</span> Realizar o Sorteio</h2>
      <p>Clique no botão abaixo para sortear as Amigas de Oração:</p>
      <button id="draw-button" disabled>
        <div class="spinner" id="draw-spinner"></div>
        Realizar Sorteio
      </button>
      
      <div id="results-container" class="result-container hidden">
        <h3>Resultado do Sorteio:</h3>
        <table id="results-table">
          <thead>
            <tr>
              <th>Participante</th>
              <th>Amiga de Oração</th>
            </tr>
          </thead>
          <tbody id="results-tbody"></tbody>
        </table>
      </div>
    </div>
    
    <div class="step">
      <h2><span class="step-number">3</span> Enviar Resultados</h2>
      <p>Clique abaixo para enviar os resultados para cada participante via WhatsApp:</p>
      <button id="send-button" class="whatsapp-button" disabled>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="0" stroke-linecap="round" stroke-linejoin="round">
          <path d="M17.498 14.382c-.301-.15-1.767-.867-2.04-.966-.273-.101-.473-.15-.673.15-.197.295-.771.964-.944 1.162-.175.195-.349.21-.646.075-.3-.15-1.263-.465-2.403-1.485-.888-.795-1.484-1.77-1.66-2.07-.174-.3-.019-.465.13-.615.136-.135.301-.345.451-.523.146-.181.194-.301.297-.496.1-.21.049-.375-.025-.524-.075-.15-.672-1.62-.922-2.206-.24-.584-.487-.51-.672-.51-.172-.015-.371-.015-.571-.015-.2 0-.523.074-.798.359-.273.3-1.045 1.02-1.045 2.475s1.07 2.865 1.219 3.075c.149.195 2.105 3.195 5.1 4.485.714.3 1.27.48 1.704.629.714.227 1.365.195 1.88.121.574-.091 1.767-.721 2.016-1.426.255-.705.255-1.29.18-1.425-.074-.135-.27-.21-.57-.345m-5.446 7.443h-.016c-1.77 0-3.524-.48-5.055-1.38l-.36-.214-3.75.975 1.005-3.645-.239-.375c-.99-1.576-1.516-3.391-1.516-5.26 0-5.445 4.455-9.885 9.942-9.885 2.654 0 5.145 1.035 7.021 2.91 1.875 1.859 2.909 4.35 2.909 6.99-.004 5.444-4.46 9.885-9.935 9.885M20.52 3.449C18.24 1.245 15.24 0 12.045 0 5.463 0 .104 5.334.101 11.893c0 2.096.549 4.14 1.595 5.945L0 24l6.335-1.652c1.746.943 3.71 1.444 5.71 1.447h.006c6.585 0 11.946-5.336 11.949-11.896 0-3.176-1.24-6.165-3.495-8.411"/>
        </svg>
        Enviar Resultados por WhatsApp
      </button>
      <p class="instruction">Para cada participante, será aberto o WhatsApp Web com uma mensagem personalizada.</p>
    </div>
  </main>
  
  <div class="modal" id="participant-modal">
    <div class="modal-content">
      <h3 class="modal-title">Enviar Mensagens</h3>
      <div id="participants-list"></div>
      <button class="close-button" id="close-modal">Fechar</button>
    </div>
  </div>
  
  <footer>
    <p>Amigas de Oração &copy; 2025</p>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // Variáveis globais
    let participants = [];
    let drawResults = [];
    const baseUrl = window.location.href.split('?')[0];
    
    // Elementos DOM
    const fileInput = document.getElementById('file-input');
    const dropArea = document.getElementById('drop-area');
    const preview = document.getElementById('preview');
    const participantsTable = document.getElementById('participants-tbody');
    const drawButton = document.getElementById('draw-button');
    const drawSpinner = document.getElementById('draw-spinner');
    const resultsContainer = document.getElementById('results-container');
    const resultsTable = document.getElementById('results-tbody');
    const sendButton = document.getElementById('send-button');
    const participantModal = document.getElementById('participant-modal');
    const participantsList = document.getElementById('participants-list');
    const closeModal = document.getElementById('close-modal');
    
    // Event Listeners
    fileInput.addEventListener('change', handleFileUpload);
    dropArea.addEventListener('click', () => fileInput.click());
    dropArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropArea.style.borderColor = '#8e44ad';
    });
    dropArea.addEventListener('dragleave', () => {
      dropArea.style.borderColor = '#ddd';
    });
    dropArea.addEventListener('drop', (e) => {
      e.preventDefault();
      dropArea.style.borderColor = '#ddd';
      if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        handleFileUpload();
      }
    });
    drawButton.addEventListener('click', performDraw);
    sendButton.addEventListener('click', showParticipantModal);
    closeModal.addEventListener('click', () => participantModal.style.display = 'none');
    
    // Funções
    function handleFileUpload() {
      const file = fileInput.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet);
          
          // Validar dados
          if (!validateData(jsonData)) {
            alert('O arquivo deve conter as colunas "Nome" e "WhatsApp"');
            return;
          }
          
          participants = jsonData.map(row => ({
            nome: row.Nome,
            whatsapp: formatWhatsApp(row.WhatsApp)
          }));
          
          displayParticipants();
          drawButton.disabled = participants.length < 2;
        } catch (error) {
          console.error(error);
          alert('Erro ao processar o arquivo. Verifique se o formato está correto.');
        }
      };
      
      reader.readAsArrayBuffer(file);
    }
    
    function validateData(data) {
      if (!data.length) return false;
      return data.every(row => row.Nome && row.WhatsApp);
    }
    
    function formatWhatsApp(number) {
      // Remover caracteres não numéricos
      let cleaned = String(number).replace(/\D/g, '');
      
      // Garantir que tenha o código do país Brasil
      if (cleaned.length === 11) {
        cleaned = '55' + cleaned;
      } else if (cleaned.length === 10) {
        // Adicionar o 9 para celulares
        cleaned = '55' + cleaned.substring(0, 2) + '9' + cleaned.substring(2);
      }
      
      return cleaned;
    }
    
    function displayParticipants() {
      participantsTable.innerHTML = '';
      participants.forEach(p => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${p.nome}</td>
          <td>${formatDisplayWhatsApp(p.whatsapp)}</td>
        `;
        participantsTable.appendChild(row);
      });
      preview.classList.remove('hidden');
    }
    
    function formatDisplayWhatsApp(number) {
      if (number.startsWith('55')) {
        const ddd = number.substring(2, 4);
        const firstPart = number.substring(4, 9);
        const secondPart = number.substring(9);
        return `+55 (${ddd}) ${firstPart}-${secondPart}`;
      }
      return number;
    }
    
    function performDraw() {
      if (participants.length < 2) {
        alert('É necessário pelo menos 2 participantes para realizar o sorteio');
        return;
      }
      
      drawSpinner.style.display = 'inline-block';
      drawButton.disabled = true;
      
      // Simular processamento
      setTimeout(() => {
        // Algoritmo de sorteio (Fisher-Yates shuffle)
        const shuffled = [...participants];
        drawResults = [];
        
        // Embaralhar a lista
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        
        // Atribuir amigas de oração de forma circular
        for (let i = 0; i < participants.length; i++) {
          const nextIndex = (i + 1) % participants.length;
          drawResults.push({
            participant: participants[i],
            friend: shuffled[nextIndex]
          });
        }
        
        displayResults();
        drawSpinner.style.display = 'none';
        sendButton.disabled = false;
      }, 1500);
    }
    
    function displayResults() {
      resultsTable.innerHTML = '';
      drawResults.forEach(result => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${result.participant.nome}</td>
          <td>${result.friend.nome}</td>
        `;
        resultsTable.appendChild(row);
      });
      resultsContainer.classList.remove('hidden');
    }
    
    function showParticipantModal() {
      participantsList.innerHTML = '';
      
      drawResults.forEach(result => {
        const card = document.createElement('div');
        card.className = 'participant-card';
        
        card.innerHTML = `
          <div>${result.participant.nome}</div>
          <button class="whatsapp-button" style="margin-top: 0; padding: 8px 12px;" 
            onclick="sendWhatsApp('${result.participant.whatsapp}', '${result.participant.nome}', '${result.friend.nome}')">
            Enviar
          </button>
        `;
        
        participantsList.appendChild(card);
      });
      
      participantModal.style.display = 'flex';
    }
    
    function sendWhatsApp(whatsapp, participantName, friendName) {
      // Gerar um token único para o link
      const token = generateToken(participantName, friendName);
      
      // Criar o link para a página de resultado
      const resultLink = `${baseUrl}?token=${token}`;
      
      // Mensagem personalizada
      const message = `A paz do Senhor irmã ${participantName}! 
      
      É com alegria que compartilho o nome da sua Amiga de Oração! A partir de hoje, você tem a missão especial de orar por ela, intercedendo por sua vida, família e caminhada com Deus.
      
      Sua Amiga de Oração é: *${friendName}*
      
    
      `;
      
      // Armazenar o resultado no localStorage para consulta posterior
      localStorage.setItem(token, friendName);
      
      // Abrir WhatsApp Web
      const whatsappUrl = `https://wa.me/${whatsapp}?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');
    }
    
    function generateToken(name1, name2) {
      const combined = name1 + name2 + new Date().getTime();
      let hash = 0;
      for (let i = 0; i < combined.length; i++) {
        const char = combined.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return Math.abs(hash).toString(16);
    }
    
    // Verificar se há um token na URL para mostrar o resultado
    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      
      if (token) {
        const friendName = localStorage.getItem(token);
        
        if (friendName) {
          // Esconder o conteúdo principal
          document.querySelector('main').style.display = 'none';
          
          // Criar uma nova tela para mostrar o resultado
          const resultView = document.createElement('div');
          resultView.className = 'result-view';
          resultView.style.cssText = `
            max-width: 600px;
            width: 90%;
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
          `;
          
          resultView.innerHTML = `
            <h2>Sua Amiga de Oração</h2>
            <p style="margin: 1.5rem 0;">Você irá orar por:</p>
            <div style="
              font-size: 2rem;
              font-weight: bold;
              color: #8e44ad;
              margin: 2rem 0;
              padding: 1.5rem;
              border: 2px solid #8e44ad;
              border-radius: 10px;
            ">${friendName}</div>
            <p style="margin-top: 2rem;">
              Que Deus abençoe você e sua amiga de oração nesta jornada especial!
            </p>
          `;
          
          // Inserir após o header
          document.querySelector('header').insertAdjacentElement('afterend', resultView);
        }
      }
    });
  </script>
</body>
</html>